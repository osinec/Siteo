// База данных рецептов
let currentCategory = null;

const data = {
    breakfast: [
        {
            title: "Грибной омлет",
            photo: "грибной омлет(завтрак).png",
            ingredients: ["шампиньоны 100 - 150 гр", "2 яйца", "соль и специи", "лук 1/4"],
            steps: [
                { step: "Грибы режем произвольно, лук измельчаем" },
                { step: "Обжариваем на масле до золотистого цвета" },
                { step: "Яйца взбиваем вилкой и выливаем на обжаренные грибы" },
                { step: "Можно все перемешать - получится скрамбл / пожарить на каждой стороне, как блин" }
            ],
            time: "10 минут",
            calories: 250
        },
        {
            title: "Бутерброды из отрубей (муки или овсянки)",
            photo: "Бутерброды_из_отрубей.png",
            ingredients: [
                "2 ст. л. отрубей (пшеничных или овсяных)",
                "1 яйцо",
                "1,5 ст. л. мягкого творога или сметаны",
                "1/3 ч. л. разрыхлителя",
                "соль, перец, зелень (по вкусу)"
            ],
            steps: [
                { step: "Смешать все ингредиенты." },
                { step: "Выпекать в микроволновке 4 минуты." },
                { step: "Дать остыть, затем намазать хлебную основу на кусок хруста." },
                { step: "Варианты начинки: ветчина 30 г + вареное яйцо + зелень; запеченные баклажаны с чесноком и помидором 100 г; тунец 50 г + яйцо + сметана + зелень; малосоленая рыба 30 г + сметана + зелень." }
            ],
            time: "4 минуты + остывание",
            calories: 180
        },
        {
            title: "Ленивые пирожки с зеленым луком",
            photo: "ленивые_пирожки.png",
            ingredients: [
                "2 яйца (сварить вкрутую)",
                "1 яичный белок (сырой)",
                "зелёный лук — по вкусу",
                "1 ст. ложка сметаны",
                "½ ст. ложки муки",
                "специи — по вкусу"
            ],
            steps: [
                { step: "Нарежьте варёные яйца кубиками, смешайте с мелко нарезанным луком." },
                { step: "В отдельной миске взбейте сырой белок со сметаной, мукой и специями." },
                { step: "Соедините обе смеси, аккуратно перемешайте." },
                { step: "Жарьте на сковороде под крышкой по 3 минуты с каждой стороны." }
            ],
            time: "15 минут",
            calories: 200
        },
        {
            title: "Блинчики с медом",
            photo: "блинчики_мед.jpg",
            ingredients: ["100 г муки", "1 яйцо", "100 мл молока", "мед"],
            steps: [
                { step: "Смешайте муку, яйцо и молока до однородности." },
                { step: "Выпекайте блины на сковороде." },
                { step: "Полейте медом перед подачей." }
            ],
            time: "10 минут",
            calories: 220
        },
        {
            title: "Ленивые хачапури на кефире",
            photo: "Ленивый_хачапури.png",
            ingredients: [
                "100 г сыра (лучше сулугуни + мягкий сыр)",
                "1 яйцо",
                "100 мл кефира (или йогурт/сметана)",
                "50 г муки",
                "15 г сливочное масло",
                "соль (по необходимости — сулугуни и так солёный)"
            ],
            steps: [
                { step: "Натрите сыр на тёрке, добавьте яйцо и кефир, перемешайте." },
                { step: "Всыпьте муку до консистенции густой сметаны." },
                { step: "Вылейте тесто на сковороду с разогретым маслом, разровняйте." },
                { step: "Жарьте под крышкой на малом огне до сухости сверху (~5–7 мин)." },
                { step: "Переверните и дожарьте до золотистой корочки с другой стороны." },
                { step: "Остудите немного, нарежьте порциями, подавайте со сметаной или зеленью." }
            ],
            time: "20 минут",
            calories: 280
        }
    ],
    lunch: [
        {
            title: "Куриная запеканка с овощами",
            photo: "куриная_запеканка.png",
            ingredients: [
                "Куриное филе — 100 г",
                "Баклажан — 100 г",
                "Помидор — 1 шт.",
                "Лук — 1 шт.",
                "Сыр — 1 ст. л.",
                "Сметана — 20 г",
                "Специи по вкусу"
            ],
            steps: [
                { step: "Обжарьте кубиками курицу и баклажаны с луком, добавьте специи." },
                { step: "Влейте яйцо, добавьте помидор и сметану, перемешайте." },
                { step: "Выложите в форму для запекания, запекайте 30 минут при 180°C." },
                { step: "Добавьте сметану, запекайте ещё 5 минут." }
            ],
            time: "40 минут",
            calories: 320,
            note: "День: 1-й обед"
        },
        {
            title: "Курочка тушеная с фасолью",
            photo: "курица_с_фасолью.png",
            ingredients: [
                "Куриное филе — 100 г",
                "Помидор — 1 шт.",
                "Болгарский перец — 1 шт.",
                "Лук — ½ шт.",
                "Фасоль консервированная — 100 г",
                "Томатная паста/соус — 1 ст. л.",
                "Специи и зелень по вкусу"
            ],
            steps: [
                { step: "Обжарьте курицу 5 минут, добавьте лук, готовьте 3–4 минуты." },
                { step: "Влейте томатную пасту, добавьте перец, помидор, специи, тушите 5–7 минут." },
                { step: "Добавьте фасоль, перемешайте, накройте крышкой и тушите до готовности." }
            ],
            time: "25 минут",
            calories: 280,
            note: "День: 6-й обед"
        },
        {
            title: "Куриный рулет с яйцом и ветчиной",
            photo: "куриный_рулет.png",
            ingredients: [
                "Куриная грудка — 150 г",
                "Лук — ½ шт.",
                "Яйцо — 1 шт.",
                "Ветчина — 30–50 г",
                "Паприка/специи по вкусу"
            ],
            steps: [
                { step: "Измельчите грудку в блендере с луком и специями." },
                { step: "Если масса густая, разбавьте молоком." },
                { step: "На пергамент выложите смесь, добавьте ветчину и яйцо, сверните в рулет." },
                { step: "Запекайте при 180°C 25–30 минут." }
            ],
            time: "40 минут",
            calories: 350,
            note: "День: 7-й обед"
        },
        {
            title: "Рыба с горчицей и сметаной",
            photo: "рыба_с_горчицей.png",
            ingredients: [
                "Рыба (филе: палтус, минтай, горбуша) — 150–200 г",
                "Сметана — 1 ст. л.",
                "Горчица — 1 ст. л.",
                "Сыр — 10 г"
            ],
            steps: [
                { step: "Посолите рыбу, выложите в форму." },
                { step: "Смешайте сметану с горчицей, намажьте на рыбу." },
                { step: "Запекайте при 180°C 15–20 минут." },
                { step: "За 5 минут до готовности добавьте сыр." }
            ],
            time: "25 минут",
            calories: 220,
            note: "День: 8-й обед"
        },
        {
            title: "Говядина с томатами и перцем",
            photo: "говядина_с_томатами.png",
            ingredients: [
                "Говядина (вырезка) — 150 г",
                "Помидор — 1 шт.",
                "Болгарский перец — 1 шт.",
                "Лук — ½ шт.",
                "Томатная паста — 1 ст. л.",
                "Специи/соль по вкусу"
            ],
            steps: [
                { step: "Обжарьте говядину на масле 10 минут." },
                { step: "Добавьте лук, готовьте 3–5 минут." },
                { step: "Влейте томатную пасту, добавьте перец, специи." },
                { step: "Тушите под крышкой до готовности." }
            ],
            time: "30 минут",
            calories: 280,
            note: "День: 10-й обед"
        }
    ],
    dinner: [
        {
            title: "Белковый рулет с крабовыми палочками",
            photo: "рулет_крабовые_палочки.png",
            ingredients: [
                "1 яйцо + 1 белок",
                "крабовые палочки 50-70 г",
                "помидор 1 шт. средний",
                "сметана 1-2 ст. л.",
                "зелень по вкусу",
                "соль и специи"
            ],
            steps: [
                { step: "Яйцо и белок взбить с щепоткой соли и специями." },
                { step: "Вылить на сковороду, жарить 1 минуту с каждой стороны до готовности омлета." },
                { step: "Крабовые палочки нарезать кубиками, помидор мелко нарезать." },
                { step: "Смешать крабовые палочки, помидор, сметану и зелень." },
                { step: "Выложить начинку на омлет, свернуть в рулет." },
                { step: "При желании можно слегка подрумянить рулет на сковороде." }
            ],
            time: "15 минут",
            calories: 180,
            note: "День: 2-й ужин"
        },
        {
            title: "Салат с кальмаром",
            photo: "салат_с_кальмарами.png",
            ingredients: [
                "кальмар 150 г",
                "огурец 1 шт.",
                "яйцо 1 шт.",
                "сметана 2 ст. л.",
                "специи по вкусу"
            ],
            steps: [
                { step: "Кальмара очистить, опустить в кипящую воду, варить не более 10 минут (иначе станет резиновым). Охладить и нарезать соломкой." },
                { step: "Яйцо взбить со щепоткой соли, вылить на сковороду, жарить 1-2 минуты с каждой стороны до готовности омлета. Остудить и нарезать полосками." },
                { step: "Огурец нарезать соломкой или полукружочками." },
                { step: "Соединить кальмара, омлет и огурец в миске." },
                { step: "Заправить сметаной, добавить специи по вкусу, аккуратно перемешать." }
            ],
            time: "20 минут",
            calories: 210,
            note: "День: 3-й ужин"
        },
        {
            title: "Салат с креветками",
            photo: "салат_с_креветками.png",
            ingredients: [
                "креветки 100-150 г",
                "капуста пекинская 100 г",
                "помидоры черри 5-7 шт.",
                "соевый соус 1 ст. л.",
                "горчица 1 ч. л. для заправки"
            ],
            steps: [
                { step: "Капусту нашинковать, помидоры черри разрезать пополам." },
                { step: "Выложить капусту и помидоры на тарелку горкой." },
                { step: "Креветки обжарить на сковороде 2-3 минуты." },
                { step: "Влить соевый соус к креветкам, жарить ещё 2-3 минуты, пока соус не начнет выпариваться." },
                { step: "Выложить горячие креветки на овощную подушку." },
                { step: "Подавать с горчицей в качестве заправки." }
            ],
            time: "15 минут",
            calories: 190,
            note: "День: 8-й ужин"
        },
        {
            title: "Запеканка с горбушей и брокколи",
            photo: "запеканка_с_горубушей.png",
            ingredients: [
                "брокколи 150 г",
                "горбуша 150 г",
                "сметана 10% 3-4 ст. л.",
                "яйцо 1 шт.",
                "специи по вкусу"
            ],
            steps: [
                { step: "Брокколи разобрать на соцветия, можно бланшировать 2-3 минуты в кипятке." },
                { step: "Горбушу нарезать на небольшие кусочки." },
                { step: "В миске соединить сметану с яйцом и специями, взбить вилкой." },
                { step: "Добавить брокколи и горбушу к соусу, аккуратно перемешать." },
                { step: "Выложить смесь в форму для запекания." },
                { step: "Выпекать при 160-180°С 20-25 минут до золотистой корочки." }
            ],
            time: "30 минут",
            calories: 240,
            note: "День: 10-й ужин"
        },
        {
            title: "Макароны с копчёными колбасками в сливочном соусе",
            photo: "Макароны_с_копчёными колбасками.png",
            ingredients: [
                "макароны из твёрдых сортов пшеницы 200 г",
                "копчёные колбаски или копчёная колбаса 100 г",
                "помидор 180 г (1 шт.)",
                "сливки 20% 150 мл",
                "твёрдый сыр 100 г",
                "фиолетовый лук 60 г (½ шт.)",
                "чеснок 1 зубчик",
                "соль 1 ч. л.",
                "чёрный молотый перец щепотка",
                "сушёный базилик ½ ч. л.",
                "растительное масло 30 мл (2 ст. л.)",
                "свежая кинза или петрушка для подачи"
            ],
            steps: [
                { step: "Лук мелко нарежьте кубиками, чеснок порубите, колбаски — тонкими кружочками." },
                { step: "Разогрейте масло в глубокой сковороде, обжарьте лук, чеснок и колбаски 3–4 минуты до золотистости." },
                { step: "Помидор залейте кипятком на 1 минуту, снимите кожицу и нарежьте мелкими кубиками." },
                { step: "Добавьте помидор в сковороду, жарьте 1–2 минуты до мягкости." },
                { step: "Влейте сливки, добавьте базилик, ½ ч. л. соли и перец. Тушите 7–8 минут на среднем огне до загустения соуса." },
                { step: "Параллельно отварите макароны в 1,5 л подсолённой воды (½ ч. л. соли) 10–12 минут до готовности. Слейте воду." },
                { step: "Добавьте макароны в сковороду с соусом, хорошо перемешайте." },
                { step: "Добавьте тёртый на крупной тёрке сыр, перемешайте и прогрейте 1 минуту до расплавления." },
                { step: "Подавайте с свежей зеленью." }
            ],
            time: "30 минут",
            calories: 420
        }
    ],
    dessert: [
        {
            title: "Пирог «Искушение в раю»",
            photo: "пирог_искушение.png",
            ingredients: [
                "Для теста:",
                "Сливочное масло — 120 г",
                "Какао-порошок — 50 г",
                "Сахар — 80 г",
                "Мука — 400 г (2,5 стакана)",
                "Разрыхлитель — 2 ч. ложки",
                "",
                "Для начинки:",
                "Творог — 400 г",
                "Творожная масса с изюмом — 200 г",
                "Сахар — 2-3 ст. ложки",
                "Яйца — 4 шт.",
                "Крахмал — 2 ст. ложки",
                "Ваниль — 1 щепотка",
                "Персики — 4 шт."
            ],
            steps: [
                { step: "Смешать муку с разрыхлителем." },
                { step: "Растопить масло, смешать с сахаром, какао-порошком и мукой. Тесто получается крошкообразным, как песок." },
                { step: "Для начинки смешать творог, творожную массу с изюмом, сахар, яйца, крахмал и ваниль." },
                { step: "Персики вымыть и нарезать дольками." },
                { step: "На дно формы выложить половину теста, сверху — часть начинки." },
                { step: "Уложить персики, выложить оставшуюся начинку и присыпать оставшимся тестом." },
                { step: "Выпекать при 200°C около 1 часа." }
            ],
            time: "1 час 20 минут",
            calories: 380,
            note: "Автор: Man'ka"
        },
        {
            title: "Пончики на сгущёнке",
            photo: "пончики_сгущенка.png",
            ingredients: [
                "Мука — 150-175 г (1 стакан)",
                "Сгущённое молоко — 100 г",
                "Яйцо — 1 шт.",
                "Разрыхлитель — 0,5 ч. л.",
                "Соль — 1 щепотка",
                "Рафинированное подсолнечное масло для фритюра — 160 мл",
                "Сахарная пудра — для посыпки"
            ],
            steps: [
                { step: "Сгущённое молоко перелить в миску, добавить яйцо и соль, взбить до однородности." },
                { step: "Просеять муку с разрыхлителем прямо в смесь и замесить пластичное тесто." },
                { step: "Завернуть тесто в плёнку и дать отдохнуть 15 минут." },
                { step: "Обмять тесто на столе (без дополнительной муки), разделить на 3 части." },
                { step: "Скатать из частей тонкие колбаски и нарезать кусочками по 1,5-2 см." },
                { step: "Скатать из кусочков шарики (тесто не липнет к рукам)." },
                { step: "Разогреть масло в сотейнике и обжаривать пончики небольшими партиями на среднем огне до румяной корочки." },
                { step: "Готовые пончики выкладывать на салфетку для удаления излишков масла, затем посыпать сахарной пудрой." }
            ],
            time: "35 минут",
            calories: 280,
            note: "Автор: anastasiya.panait"
        },
        {
            title: "Классический чизкейк",
            photo: "чизкейк.png",
            ingredients: [
                "Для основы:",
                "Крекеры — 200 г",
                "Сливочное масло (растопленное) — 100 г",
                "Сахар — 50 г",
                "Соль — ¼ ч. л.",
                "",
                "Для начинки:",
                "Сливочный сыр (Филадельфия, Альметте и т.п.) — 1 кг",
                "Жирная сметана (30%) — 1 стакан (200-250 г)",
                "Крупные яйца — 4 шт.",
                "Сахар — 1 стакан (или по вкусу)",
                "Измельчённая лимонная цедра — 1 ч. л.",
                "Лимонный сок — 1 ст. л.",
                "Соль — ½ ч. л."
            ],
            steps: [
                { step: "Разогреть духовку до 180°C. Смазать маслом разъёмную форму." },
                { step: "Измельчить крекеры в блендере, добавить растопленное масло, сахар и соль, перемешать." },
                { step: "Выложить массу в форму, равномерно распределить по дну и краям, придавливая пальцами." },
                { step: "Выпекать основу при 150°C 12-15 минут, затем остудить на решётке." },
                { step: "Взбить сливочный сыр (комнатной температуры) миксером на средней скорости." },
                { step: "Постепенно добавить сахар, лимонную цедру, сок и соль." },
                { step: "Вбить яйца по одному, добавить сметану, взбить до однородности." },
                { step: "Завернуть низ формы в фольгу, вылить начинку на основу, слегка стукнуть формой о стол для удаления пузырьков воздуха." },
                { step: "Поставить форму в глубокий противень, налить кипяток до половины высоты формы (водяная баня)." },
                { step: "Выпекать: сначала при 200°C 10-15 минут, затем уменьшить температуру до 110-120°C и выпекать ещё около 1,5 часов." },
                { step: "Вынуть из воды, оставить в выключенной духовке на 20 минут, затем остудить при комнатной температуре." },
                { step: "Провести ножом по стенкам формы, убрать в холодильник на несколько часов (лучше на ночь), затем аккуратно снять бортик." }
            ],
            time: "2 часа 30 минут",
            calories: 450,
            note: "Автор: Milania"
        },
        {
            title: "Рафаэлло (быстрый способ)",
            photo: "рафаэлло.png",
            ingredients: [
                "Кукурузные палочки — 60 г",
                "Сгущённое молоко — 5-6 ст. л.",
                "Сливочное масло (размягчённое) — ½ ч. л.",
                "Кокосовая стружка — 100 г",
                "Арахис — горсть"
            ],
            steps: [
                { step: "Перемолоть кукурузные палочки через мясорубку." },
                { step: "Добавить сгущёнку и размягчённое масло, перемешать до однородной массы." },
                { step: "Отправить тесто в холодильник на 1 час для скрепления." },
                { step: "Тем временем поджарить арахис, остудить и снять шелуху." },
                { step: "Достать тесто из холодильника. С помощью чайной ложки отщипнуть порцию, сформировать лепёшку." },
                { step: "Положить в центр арахис, защипнуть края и сформировать шарик." },
                { step: "Обвалять шарик в кокосовой стружке." },
                { step: "При наличии — разложить в формочки для конфет, отправить в холодильник." },
                { step: "Доставать за 5 минут до подачи." }
            ],
            time: "1 час 20 минут",
            calories: 220,
            note: "Автор: Тина Рябченко"
        },
        {
            title: "Творожные сырки в шоколаде с вареньем",
            photo: "творожные_сырки.png",
            ingredients: [
                "Молочный шоколад — 180 г",
                "Творог — 300 г",
                "Сливочное масло — 40 г (размягчённое)",
                "Сахарная пудра — 3 ст. ложки",
                "Ванилин — 1 щепотка",
                "Соль — 1 щепотка",
                "Варенье (яблочное или другое) — 6 ч. ложек (около 100 г)"
            ],
            steps: [
                { step: "Соединить в блендере творог, сахарную пудру, соль, ванилин и мягкое сливочное масло." },
                { step: "Измельчить до получения гладкой творожной массы." },
                { step: "Растопить шоколад на водяной бане или в микроволновке импульсами по 10-15 секунд." },
                { step: "Смазать растопленным шоколадом дно и бортики силиконовых формочек (полусфера или для маффинов)." },
                { step: "Поставить формочки в морозилку на 5 минут до застывания первого слоя." },
                { step: "Нанести второй слой шоколада и снова отправить в морозилку на 5 минут." },
                { step: "Переложить творожную массу в кондитерский мешок." },
                { step: "Отсадить массу в шоколадные «гнёздышки», оставляя углубление для начинки." },
                { step: "В углубления выложить варенье (можно заменить варёной сгущёнкой или шоколадно-ореховой пастой)." },
                { step: "Накрыть начинку оставшейся творожной массой и разровнять поверхность." },
                { step: "Покрыть сырки оставшимся шоколадом и поставить в холодильник на 40-60 минут." },
                { step: "Аккуратно извлечь сырки из формочек и подавать к горячему напитку." }
            ],
            time: "1 час 30 минут",
            calories: 320,
            note: "Автор: anastasiya.panait"
        }
    ]
};

// Кэш для предзагрузки изображений
const imageCache = new Map();
const fallbackImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDQwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGMEYwRjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkludGVyIiBmb250LXNpemU9IjE0IiBmaWxsPSIjODg4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+PHQzc3Bhbj5Gb29kIEltYWdlPC90c3Bhbj48L3RleHQ+PC9zdmc+';

// Предзагрузка изображений для быстрого отображения
function preloadImages() {
    console.log('Начинаем предзагрузку изображений...');
    
    const allRecipes = Object.values(data).flat();
    let loadedCount = 0;
    const totalImages = allRecipes.length;
    
    allRecipes.forEach(recipe => {
        if (recipe.photo) {
            const img = new Image();
            img.onload = () => {
                loadedCount++;
                imageCache.set(recipe.photo, img);
                console.log(`✓ Загружено: ${recipe.title}`);
                if (loadedCount === totalImages) {
                    console.log('✅ Все изображения загружены!');
                }
            };
            img.onerror = () => {
                loadedCount++;
                console.log(`✗ Ошибка загрузки: ${recipe.photo} для "${recipe.title}"`);
                // Загружаем fallback изображение
                const fallbackImg = new Image();
                fallbackImg.onload = () => {
                    imageCache.set(recipe.photo, fallbackImg);
                };
                fallbackImg.src = fallbackImage;
            };
            // Добавляем таймстамп для избежания кэширования
            img.src = recipe.photo + '?' + new Date().getTime();
        }
    });
}

// Функции для работы с модальным окном
function openModal() {
    document.getElementById("modal").style.display = "flex";
    document.body.style.overflow = "hidden";
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
    document.body.style.overflow = "auto";
}

// Выбор категории
function selectCategory(category) {
    currentCategory = category;
    closeModal();
    
    // Показываем кнопку обновления сразу после выбора категории
    const refreshBtn = document.getElementById("refresh");
    if (refreshBtn) {
        refreshBtn.style.display = "inline-block";
    }
    
    generateRecipe();
}

// Генерация случайного рецепта
function random(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function generateRecipe() {
    if (!currentCategory) {
        alert('Сначала выберите категорию!');
        openModal();
        return;
    }

    if (!data[currentCategory]) {
        alert('Рецепты для этой категории не найдены!');
        return;
    }

    const recipe = random(data[currentCategory]);

    // Обновляем данные на странице
    document.getElementById("category").innerText = currentCategory.toUpperCase();
    document.getElementById("title").innerText = recipe.title;

    const photoEl = document.getElementById("photo");
    
    // Сначала показываем заглушку
    photoEl.style.display = "block";
    photoEl.src = fallbackImage;
    photoEl.alt = recipe.title;
    
    // Создаем новое изображение для загрузки
    const img = new Image();
    img.onload = function() {
        console.log(`✅ Изображение загружено: ${recipe.title}`);
        photoEl.src = this.src;
        // Сохраняем в кэш
        imageCache.set(recipe.photo, img);
    };
    img.onerror = function() {
        console.log(`❌ Ошибка загрузки изображения: ${recipe.photo}`);
        // Оставляем fallback изображение
    };
    // Пытаемся загрузить из кэша или напрямую
    if (imageCache.has(recipe.photo)) {
        const cachedImg = imageCache.get(recipe.photo);
        photoEl.src = cachedImg.src;
    } else {
        // Добавляем таймстамп для избежания кэширования
        img.src = recipe.photo + '?' + new Date().getTime();
    }

    // Отображаем ингредиенты
    const ingredientsText = recipe.ingredients.join(", ");
    document.getElementById("ingredients").innerHTML = `<span>Ингредиенты:</span> ${ingredientsText}`;

    // Отображаем шаги приготовления
    const stepsEl = document.getElementById("steps");
    stepsEl.innerHTML = "";
    recipe.steps.forEach((s, index) => {
        const li = document.createElement("li");
        li.innerText = `${index + 1}. ${s.step}`;
        stepsEl.appendChild(li);
    });

    // Отображаем время и калории
    document.getElementById("time").innerHTML = `<span>Время приготовления:</span> ${recipe.time}`;
    document.getElementById("calories").innerHTML = `<span>Калорийность:</span> ${recipe.calories} ккал`;

    // Добавляем примечание, если оно есть
    const noteElement = document.getElementById("note");
    if (noteElement) {
        if (recipe.note) {
            noteElement.innerHTML = `<span>Примечание:</span> ${recipe.note}`;
            noteElement.style.display = "block";
        } else {
            noteElement.style.display = "none";
        }
    }

    // ВСЕГДА показываем кнопку обновления, когда рецепт сгенерирован
    const refreshBtn = document.getElementById("refresh");
    if (refreshBtn) {
        refreshBtn.style.display = "inline-block";
    }
    
    // Прокручиваем к началу для удобства
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Инициализация при загрузке страницы
document.addEventListener("DOMContentLoaded", () => {
    console.log('Генератор рецептов загружен! Всего рецептов:', 
        Object.values(data).reduce((sum, arr) => sum + arr.length, 0));
    
    // Предзагрузка изображений (начинаем через небольшой таймаут)
    setTimeout(preloadImages, 500);
    
    // Назначаем обработчики для кнопок
    const refreshBtn = document.getElementById("refresh");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", generateRecipe);
        refreshBtn.style.display = "none";
    }
    
    const randomBtn = document.querySelector('.main-btn');
    if (randomBtn) {
        randomBtn.addEventListener("click", openModal);
    }
    
    // Назначаем обработчики для кнопок категорий в модальном окне
    document.querySelectorAll('.choice').forEach(button => {
        button.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            if (category) {
                selectCategory(category);
            }
        });
    });

    // Закрытие модального окна при клике вне его
    const modal = document.getElementById("modal");
    if (modal) {
        modal.addEventListener("click", function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Закрытие по кнопке закрытия
        const closeBtn = document.querySelector('.close');
        if (closeBtn) {
            closeBtn.addEventListener("click", closeModal);
        }
    }

    // Закрытие модального окна по клавише Escape
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && modal && modal.style.display === "flex") {
            closeModal();
        }
    });

    // Инициализация примечания
    const noteElement = document.getElementById("note");
    if (noteElement) {
        noteElement.style.display = "none";
    }
});

// Экспортируем функции для использования в HTML (добавляем в глобальную область видимости)
window.openModal = openModal;
window.closeModal = closeModal;
window.selectCategory = selectCategory;
window.generateRecipe = generateRecipe;
